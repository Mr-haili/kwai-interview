## 做题时间记录

总时间: 1.5 工作日

- 0.5 工作日，完成 level 1 的功能与思考 level 3 功能实现
- 1 工作日，完成 level 3 的主要程序结构

2021-08-09 晚

- 23:00 开始文档编写
- 23:10 开始编码
- 23:55 完成 level1 大部分功能
- 00:15 EventBus 的回调中 trigger 是安全的
- 00:30 休息 15 min 继续 level 2 的功能

2021-8-10

- 02:10 完成主要功能与程序结构，大致能跑起来了

## 设计的简要记录

1. trigger 可以看做创建了一个任务，任务的执行应该是异步的，由 EventBus 内部的任务调度器去管理
2. this.trigger 应该带有当前执行任务的上下文信息
3. 任务节点通过父子关系形成一棵树形结构，每一个任务执行过程中都可以创建子任务
4. 当前任务的所有执行信息(...)都包含在这个任务树结构中，这样整个当前执行状态的打印功能可以由一个相对独立的模块完成
5. 内部的任务调度器应该做成和 EventBus 解耦的
6. 每个任务应该都是异步执行的，由调度器来触发和调度
7. 增加对无线循环调用事件的判断，可以考虑针对每个 taskProcess 维护一个以触发 event type 表，如果当前触发已经在表里面，说明当前的 taskProcess 树，出现了父节点与其某个后代节点由相同类型的事件触发，事件触发存在循环触发的情况

## 任务树的执行设计

任务树的执行可以看做一个树的后续遍历过程，树的后续遍历最自然的方式应该是通过递归的方式编写，
但是递归借用了函数调用栈和语言本身的能力来完成遍历控制。
如果希望能获得对整个流程更灵活的控制，可以在执行一个任务后暂停，并且可重入，以及对简化函数调用栈的考虑。
需要我们自己去维护整个任务的遍历状态。

## feature 列表

### 测试

- [ ] 部署基础的测试能力
- [ ] 针对各个 feature 点补足测试用例

### level 1 功能

- [x] 添加监听的时候，需要是类型安全的
- [x] 基本的监听能力
- [x] 多重监听
- [x] 触发等基本功能
- [ ] 卸载监听

### level 2 功能

- [x] 在 listener 的回调中 this 必须是类型安全
- [x] 在 listener 中可以继续触发事件，要求在总线对象内部要保持正确的事件调用栈，并能提供接口打印出来

### level 3 功能

- [x] 增加对 async callback 的支持，并要求仍然能够正确打印出调用栈。
- [ ] 增加对无线循环调用事件的判断。

## 参考资料

[ts 如何约束函数的 this 类型](https://www.typescriptlang.org/docs/handbook/2/functions.html#declaring-this-in-a-function)
